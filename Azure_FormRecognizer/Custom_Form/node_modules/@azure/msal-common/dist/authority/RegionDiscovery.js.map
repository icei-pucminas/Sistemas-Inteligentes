{"version":3,"file":"RegionDiscovery.js","sources":["../../src/authority/RegionDiscovery.ts"],"sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { INetworkModule } from \"../network/INetworkModule\";\r\nimport { NetworkResponse } from \"../network/NetworkManager\";\r\nimport { IMDSBadResponse } from \"../response/IMDSBadResponse\";\r\nimport { Constants, ResponseCodes } from \"../utils/Constants\";\r\n\r\nexport class RegionDiscovery {\r\n    // Network interface to make requests with.\r\n    protected networkInterface: INetworkModule;\r\n    // Options for the IMDS endpoint request\r\n    protected static IMDS_OPTIONS = {headers: {\"Metadata\": \"true\"}};\r\n\r\n    constructor(networkInterface: INetworkModule) {\r\n        this.networkInterface = networkInterface;\r\n    }\r\n\r\n    /**\r\n     * Detect the region from the application's environment.\r\n     * \r\n     * @returns Promise<string | null>\r\n     */\r\n    public async detectRegion(environmentRegion: string | undefined): Promise<string | null> {\r\n        // Initialize auto detected region with the region from the envrionment \r\n        let autodetectedRegionName = environmentRegion;\r\n\r\n        // Call the local IMDS endpoint for applications running in azure vms\r\n        if (!autodetectedRegionName) {\r\n            try {\r\n                const response = await this.getRegionFromIMDS(Constants.IMDS_VERSION);\r\n                if (response.status === ResponseCodes.httpSuccess) {\r\n                    autodetectedRegionName = response.body;\r\n                } \r\n                \r\n                if (response.status === ResponseCodes.httpBadRequest) {\r\n                    const latestIMDSVersion = await this.getCurrentVersion();\r\n                    if (!latestIMDSVersion) {\r\n                        return null;\r\n                    }\r\n\r\n                    const response = await this.getRegionFromIMDS(latestIMDSVersion);\r\n                    if (response.status === ResponseCodes.httpSuccess) {\r\n                        autodetectedRegionName = response.body;\r\n                    }\r\n                } \r\n            } catch(e) {\r\n                return null;\r\n            } \r\n        }\r\n\r\n        return autodetectedRegionName || null;\r\n    }\r\n\r\n    /**\r\n     * Make the call to the IMDS endpoint\r\n     * \r\n     * @param imdsEndpointUrl\r\n     * @returns Promise<NetworkResponse<string>>\r\n     */\r\n    private async getRegionFromIMDS(version: string): Promise<NetworkResponse<string>> {\r\n        return this.networkInterface.sendGetRequestAsync<string>(`${Constants.IMDS_ENDPOINT}?api-version=${version}&format=text`, RegionDiscovery.IMDS_OPTIONS, Constants.IMDS_TIMEOUT);\r\n    }\r\n\r\n    /**\r\n     * Get the most recent version of the IMDS endpoint available\r\n     *  \r\n     * @returns Promise<string | null>\r\n     */\r\n    private async getCurrentVersion(): Promise<string | null> {\r\n        try {\r\n            const response = await this.networkInterface.sendGetRequestAsync<IMDSBadResponse>(`${Constants.IMDS_ENDPOINT}?format=json`, RegionDiscovery.IMDS_OPTIONS);\r\n\r\n            // When IMDS endpoint is called without the api version query param, bad request response comes back with latest version.\r\n            if (response.status === ResponseCodes.httpBadRequest && response.body && response.body[\"newest-versions\"] && response.body[\"newest-versions\"].length > 0) {\r\n                return response.body[\"newest-versions\"][0];\r\n            }\r\n\r\n            return null;\r\n        } catch (e) {\r\n            return null;\r\n        }\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;;;;;IAgBI,yBAAY,gBAAgC;QACxC,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;KAC5C;;;;;;IAOY,sCAAY,GAAzB,UAA0B,iBAAqC;;;;;;wBAEvD,sBAAsB,GAAG,iBAAiB,CAAC;6BAG3C,CAAC,sBAAsB,EAAvB,wBAAuB;;;;wBAEF,qBAAM,IAAI,CAAC,iBAAiB,CAAC,SAAS,CAAC,YAAY,CAAC,EAAA;;wBAA/D,QAAQ,GAAG,SAAoD;wBACrE,IAAI,QAAQ,CAAC,MAAM,KAAK,aAAa,CAAC,WAAW,EAAE;4BAC/C,sBAAsB,GAAG,QAAQ,CAAC,IAAI,CAAC;yBAC1C;8BAEG,QAAQ,CAAC,MAAM,KAAK,aAAa,CAAC,cAAc,CAAA,EAAhD,wBAAgD;wBACtB,qBAAM,IAAI,CAAC,iBAAiB,EAAE,EAAA;;wBAAlD,iBAAiB,GAAG,SAA8B;wBACxD,IAAI,CAAC,iBAAiB,EAAE;4BACpB,sBAAO,IAAI,EAAC;yBACf;wBAEgB,qBAAM,IAAI,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,EAAA;;wBAA1D,aAAW,SAA+C;wBAChE,IAAI,UAAQ,CAAC,MAAM,KAAK,aAAa,CAAC,WAAW,EAAE;4BAC/C,sBAAsB,GAAG,UAAQ,CAAC,IAAI,CAAC;yBAC1C;;;;;wBAGL,sBAAO,IAAI,EAAC;4BAIpB,sBAAO,sBAAsB,IAAI,IAAI,EAAC;;;;KACzC;;;;;;;IAQa,2CAAiB,GAA/B,UAAgC,OAAe;;;gBAC3C,sBAAO,IAAI,CAAC,gBAAgB,CAAC,mBAAmB,CAAY,SAAS,CAAC,aAAa,qBAAgB,OAAO,iBAAc,EAAE,eAAe,CAAC,YAAY,EAAE,SAAS,CAAC,YAAY,CAAC,EAAC;;;KACnL;;;;;;IAOa,2CAAiB,GAA/B;;;;;;;wBAEyB,qBAAM,IAAI,CAAC,gBAAgB,CAAC,mBAAmB,CAAqB,SAAS,CAAC,aAAa,iBAAc,EAAE,eAAe,CAAC,YAAY,CAAC,EAAA;;wBAAnJ,QAAQ,GAAG,SAAwI;;wBAGzJ,IAAI,QAAQ,CAAC,MAAM,KAAK,aAAa,CAAC,cAAc,IAAI,QAAQ,CAAC,IAAI,IAAI,QAAQ,CAAC,IAAI,CAAC,iBAAiB,CAAC,IAAI,QAAQ,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE;4BACtJ,sBAAO,QAAQ,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC,EAAC;yBAC9C;wBAED,sBAAO,IAAI,EAAC;;;wBAEZ,sBAAO,IAAI,EAAC;;;;;KAEnB;;IAtEgB,4BAAY,GAAG,EAAC,OAAO,EAAE,EAAC,UAAU,EAAE,MAAM,EAAC,EAAC,CAAC;IAuEpE,sBAAC;CA3ED;;;;"}